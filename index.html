
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Product Excel Download</title>
	<style>
		body {
			font-family: 'Segoe UI', Arial, sans-serif;
			background: #f6f8fa;
			margin: 0;
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: flex-start;
		}
		.container {
			background: #fff;
			box-shadow: 0 4px 24px rgba(0,0,0,0.08);
			border-radius: 16px;
			padding: 2.5rem 2rem 2rem 2rem;
			margin-top: 3rem;
			max-width: 400px;
			width: 100%;
		}
		h2 {
			margin-top: 0;
			color: #1a202c;
			font-size: 1.6rem;
			font-weight: 600;
			letter-spacing: 0.01em;
		}
		label {
			font-size: 1.05rem;
			color: #374151;
			margin-bottom: 0.5rem;
			display: block;
		}
		select {
			width: 100%;
			padding: 0.6rem 0.8rem;
			border: 1px solid #d1d5db;
			border-radius: 8px;
			font-size: 1rem;
			margin-bottom: 1.2rem;
			background: #f9fafb;
			transition: border 0.2s;
		}
		select:focus {
			outline: none;
			border-color: #2563eb;
		}
		button {
			width: 100%;
			padding: 0.7rem 0;
			background: linear-gradient(90deg, #2563eb 60%, #1e40af 100%);
			color: #fff;
			border: none;
			border-radius: 8px;
			font-size: 1.1rem;
			font-weight: 500;
			cursor: pointer;
			box-shadow: 0 2px 8px rgba(37,99,235,0.08);
			transition: background 0.2s, box-shadow 0.2s;
		}
		button:hover {
			background: linear-gradient(90deg, #1e40af 60%, #2563eb 100%);
			box-shadow: 0 4px 16px rgba(37,99,235,0.13);
		}
		@media (max-width: 500px) {
			.container {
				padding: 1.2rem 0.5rem;
				margin-top: 1.2rem;
				max-width: 98vw;
			}
			h2 { font-size: 1.2rem; }
		}
	</style>
</head>
<body>

	<div class="container">
		<h2>Download Product Fields as Excel</h2>
		<label for="productSelect">Select Product:</label>
		<select id="productSelect">
			<option value="">-- Select --</option>
		</select>
		<button id="downloadBtn" style="display:none; margin-bottom: 1.2rem;">Download Excel</button>

		<form id="uploadForm" style="display:none; margin-top:1.2rem;">
			<label for="excelFile">Upload Filled Excel:</label>
			<input type="file" id="excelFile" name="excelFile" accept=".xlsx,.xls" required style="margin-bottom:0.7rem;">
			<button type="submit" style="margin-top:0.5rem;">Validate Excel</button>
		</form>
		<div id="validationResult" style="margin-top:1.2rem;"></div>
		<div id="downloadErrorActions" style="display:none; gap:0.5rem; margin-top:0.8rem;">
			<button id="downloadErrorsCsv" type="button">Download errors (CSV)</button>
			<button id="downloadErrorsXlsx" type="button">Download errors (Excel)</button>
		</div>

		<hr style="margin:2rem 0;">
		<h2>Download Member Details PDF</h2>
		<label for="productSelectPDF">Select Product:</label>
		<select id="productSelectPDF">
			<option value="">-- Select --</option>
		</select>
		<label for="applicationSelect" style="margin-top:1rem;display:block;">Select Application:</label>
		<select id="applicationSelect" style="margin-bottom:1rem;">
			<option value="">-- Select --</option>
		</select>
		<label for="insuredSelect" style="margin-top:1rem;display:block;">Select Insured Person:</label>
		<select id="insuredSelect" style="margin-bottom:1rem;">
			<option value="">-- Select --</option>
		</select>
		<div id="downloadButtons" style="display:none; gap:0.6rem; margin-bottom:1.2rem; flex-wrap:wrap;">
			<button id="downloadPDFBtn">Download Member PDF</button>
			<button id="downloadDOCXBtn" style="background:linear-gradient(90deg,#059669 60%,#065f46 100%);">Download Member DOCX</button>
			<button id="downloadCloudPDFBtn" style="background:linear-gradient(90deg,#9333ea 60%,#6d28d9 100%);">Download Member PDF (Cloud)</button>
		</div>
		<div id="pdfStatus" style="margin-top:1.2rem;"></div>
	</div>


	<script>
		// const BACKEND_URL = 'http://localhost:8081'; 
		const BACKEND_URL = 'https://bimakart.onrender.com'; 
		// Excel section
		const select = document.getElementById('productSelect');
		const btn = document.getElementById('downloadBtn');
		let products = [];

		// PDF section
		const selectPDF = document.getElementById('productSelectPDF');
		const applicationSelect = document.getElementById('applicationSelect');
		const insuredSelect = document.getElementById('insuredSelect');
		const downloadButtons = document.getElementById('downloadButtons');
		const downloadPDFBtn = document.getElementById('downloadPDFBtn');
		const downloadDOCXBtn = document.getElementById('downloadDOCXBtn');
		const downloadCloudPDFBtn = document.getElementById('downloadCloudPDFBtn');
		const pdfStatus = document.getElementById('pdfStatus');

		// Fetch products for both selects
		fetch(BACKEND_URL + '/api/products/active')
			.then(res => res.json())
			.then(data => {
				products = data.data || [];
				products.forEach(p => {
					const opt1 = document.createElement('option');
					opt1.value = p._id;
					opt1.textContent = p.name;
					select.appendChild(opt1);
					const opt2 = document.createElement('option');
					opt2.value = p._id;
					opt2.textContent = p.name;
					selectPDF.appendChild(opt2);
				});
			});

		// Excel download and validation logic (unchanged)
		select.addEventListener('change', function() {
			btn.style.display = select.value ? '' : 'none';
			document.getElementById('uploadForm').style.display = select.value ? '' : 'none';
			document.getElementById('validationResult').innerHTML = '';
		});

		// Single handler for Excel validation to avoid multiple bindings
		const validationResult = document.getElementById('validationResult');
		const downloadErrorActions = document.getElementById('downloadErrorActions');
		const downloadErrorsCsv = document.getElementById('downloadErrorsCsv');
		const downloadErrorsXlsx = document.getElementById('downloadErrorsXlsx');

		async function runValidation(outputFormat = 'json', download = false) {
			const productId = select.value;
			const excelFile = document.getElementById('excelFile');
			if (!productId || !excelFile.files.length) return { ok: false };
			const formData = new FormData();
			formData.append('file', excelFile.files[0]);
			const url = BACKEND_URL + `/validate-excel/${productId}?output=${outputFormat}`;
			if (download) {
				const res = await fetch(url, { method: 'POST', body: formData });
				if (!res.ok) return { ok: false };
				const blob = await res.blob();
				const a = document.createElement('a');
				a.href = window.URL.createObjectURL(blob);
				a.download = outputFormat === 'csv' ? 'validation_errors.csv' : 'validation_errors.xlsx';
				document.body.appendChild(a);
				a.click();
				a.remove();
				return { ok: true };
			}
			const res = await fetch(url, { method: 'POST', body: formData });
			if (!res.ok) return { ok: false };
			return { ok: true, data: await res.json() };
		}

		document.getElementById('uploadForm').addEventListener('submit', function(e) {
			e.preventDefault();
			downloadErrorActions.style.display = 'none';
			validationResult.innerHTML = 'Validating...';
			runValidation('json', false).then(result => {
				if (!result.ok || !result.data) {
					validationResult.innerHTML = `<span style="color:#b91c1c;">&#10007; Validation failed.</span>`;
					return;
				}
				const data = result.data;
				if (data.valid) {
					validationResult.innerHTML = `<span style="color:green;font-weight:500;">&#10003; ${data.message}</span>`;
					return;
				}
				if (data.errors) {
					validationResult.innerHTML = `<span style="color:#b91c1c;font-weight:500;">&#10007; Excel has errors:</span><ul style='color:#b91c1c;line-height:1.5;margin:0.5em 0 0 1.2em;'>` + data.errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
					downloadErrorActions.style.display = 'flex';
					return;
				}
				validationResult.innerHTML = `<span style="color:#b91c1c;">&#10007; Validation failed.</span>`;
			}).catch(() => {
				validationResult.innerHTML = `<span style="color:#b91c1c;">&#10007; Validation failed.</span>`;
			});
		});

		downloadErrorsCsv.addEventListener('click', () => {
			runValidation('csv', true);
		});
		downloadErrorsXlsx.addEventListener('click', () => {
			runValidation('excel', true);
		});

		btn.addEventListener('click', function() {
			const productId = select.value;
			if (!productId) return;
			const url = BACKEND_URL + `/excel/${productId}`;
			fetch(url)
				.then(response => {
					if (!response.ok) throw new Error('Failed to download');
					return response.blob();
				})
				.then(blob => {
					const a = document.createElement('a');
					a.href = window.URL.createObjectURL(blob);
					a.download = select.options[select.selectedIndex].text.replace(/\s+/g, '_') + '.xlsx';
					document.body.appendChild(a);
					a.click();
					a.remove();
				})
				.catch(() => alert('Download failed.'));
		});

		// PDF section logic
		selectPDF.addEventListener('change', function() {
			applicationSelect.innerHTML = '<option value="">-- Select --</option>';
			insuredSelect.innerHTML = '<option value="">-- Select --</option>';
			setDownloadButtonsVisible(false);
			pdfStatus.innerHTML = '';
			const productId = selectPDF.value;
			if (!productId) return;
			fetch(BACKEND_URL + `/api/applications?productId=${productId}`)
				.then(res => res.json())
				.then(data => {
					const apps = data.data || [];
					if (!apps.length) {
						pdfStatus.innerHTML = '<span style="color:#b91c1c;">No applications found for this product.</span>';
						return;
					}
					apps.forEach(a => {
						const opt = document.createElement('option');
						const label = [a.firstName, a.lastName].filter(Boolean).join(' ') || a.mobile || a.email || a._id;
						opt.value = a._id;
						opt.textContent = label;
						applicationSelect.appendChild(opt);
					});
				})
				.catch(() => {
					pdfStatus.innerHTML = '<span style="color:#b91c1c;">Failed to load applications.</span>';
				});
		});

		applicationSelect.addEventListener('change', function() {
			insuredSelect.innerHTML = '<option value="">-- Select --</option>';
			setDownloadButtonsVisible(false);
			pdfStatus.innerHTML = '';
			const applicationId = applicationSelect.value;
			if (!applicationId) return;
			// Fetch insured people for this application
			fetch(BACKEND_URL + `/api/insuredpeople?applicationId=${applicationId}`)
				.then(res => res.json())
				.then(data => {
					if (data && data.data && data.data.length) {
						data.data.forEach(person => {
							const opt = document.createElement('option');
							opt.value = person._id;
							opt.textContent = person.data && person.data.name ? person.data.name : person._id;
							insuredSelect.appendChild(opt);
						});
					} else {
						pdfStatus.innerHTML = '<span style="color:#b91c1c;">No insured people found for this application.</span>';
					}
				});
		});

		function setDownloadButtonsVisible(isVisible) {
			if (isVisible) {
				downloadButtons.style.display = 'flex';
			} else {
				downloadButtons.style.display = 'none';
			}
		}

		insuredSelect.addEventListener('change', function() {
			const ready = Boolean(insuredSelect.value);
			setDownloadButtonsVisible(ready);
			pdfStatus.innerHTML = '';
		});

		async function triggerMemberDownload(format, converter = 'local') {
			const applicationId = applicationSelect.value;
			const insuredId = insuredSelect.value;
			if (!applicationId || !insuredId) {
				pdfStatus.innerHTML = '<span style="color:#b91c1c;">Select application and insured person first.</span>';
				return;
			}
			const isPdf = format === 'pdf';
			const isCloud = isPdf && converter === 'cloudconvert';
			pdfStatus.innerHTML = isPdf
				? (isCloud ? 'Preparing PDF via CloudConvert...' : 'Preparing PDF...')
				: 'Preparing DOCX...';
			const endpoint = isPdf
				? `/api/member-details/${applicationId}/pdf?insuredId=${insuredId}&format=pdf${isCloud ? '&converter=cloudconvert' : ''}`
				: `/api/member-details/${applicationId}/docx?insuredId=${insuredId}`;
			try {
				const response = await fetch(BACKEND_URL + endpoint);
				if (!response.ok) {
					let detail = 'Download failed.';
					try {
						const errData = await response.json();
						detail = errData.details || errData.error || detail;
					} catch (err) {
						// ignore json parse issues
					}
					throw new Error(detail);
				}
				const blob = await response.blob();
				const a = document.createElement('a');
				a.href = window.URL.createObjectURL(blob);
				const suffix = isCloud ? '_cloud' : '';
				a.download = `MemberDetails_${insuredId}${suffix}.${isPdf ? 'pdf' : 'docx'}`;
				document.body.appendChild(a);
				a.click();
				a.remove();
				if (isPdf) {
					pdfStatus.innerHTML = `<span style="color:green;">${isCloud ? 'CloudConvert PDF downloaded.' : 'PDF downloaded.'}</span>`;
				} else {
					pdfStatus.innerHTML = '<span style="color:green;">DOCX downloaded.</span>';
				}
			} catch (error) {
				pdfStatus.innerHTML = `<span style="color:#b91c1c;">${error.message}</span>`;
			}
		}

		downloadPDFBtn.addEventListener('click', function() {
			triggerMemberDownload('pdf');
		});

		downloadDOCXBtn.addEventListener('click', function() {
			triggerMemberDownload('docx');
		});

		downloadCloudPDFBtn.addEventListener('click', function() {
			triggerMemberDownload('pdf', 'cloudconvert');
		});

	</script>
</body>
</html>
